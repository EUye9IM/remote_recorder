<html>

<head>
    <title>Simple DataChannel</title>
    <script src="js/jquery.min.js"></script>
</head>

<body>
    <!-- <form id="idform" action="" onsubmit="return false;">
        <input type="text" id="name">
        <button id="set_name">Set your name</button>
    </form> -->

    <button id="ws-connect">Connect to WebSocket</button>
    <button id="ws-disconnect">Disconnect</button>
    <br>
    <br>
    <br>

    <div>
        name: <span id="msg_name"></span><br>
        host: <span id="msg_host"></span><br>
        prot: <span id="msg_prot"></span><br>
    </div>
    <br>

    <div>
        log:
        <button onclick="$('#log_content').html('');">clear</button>
        <div id="log_content"></div>
    </div>
</body>

<script>

    function addlog(msg) {
        t = $('#log_content').html();
        t += msg + "<br>"
        $('#log_content').html(t);
    }

    var host = window.location.host;
    var is_sec = window.location.protocol == "https:";

    var peerConnection = null;

    var dataChannel = null;

    $("#msg_host").html(host);
    $("#msg_prot").html(is_sec ? "https" : "http");


    var ws = null;
    var name = "";
    $("#set_name").click(() => {
        if (ws) {
            alert("disconnect first!");
            return
        }
        name = $("#name").val()
        $("#msg_name").html(name);
        addlog("set name: " + name);
    });
    $("#ws-connect").click(() => {
        if (ws)
            return;

        u = ""
        if (is_sec)
            u = "wss://" + host + "/api/ws"
        else
            u = "ws://" + host + "/api/ws"
        addlog("connect to " + u);
        ws = new WebSocket(u);

        ws.onclose = (e) => {
            addlog("Websocket closed");
        }
        ws.onmessage = (e) => {
            addlog("Websocket message" + e.data);
            var data = JSON.parse(e.data);

            // if (json.action == "candidate") {
            //     if (json.to == user) {
            //         processIce(json.data);
            //     }
            // } else if (json.action == "offer") {
            //     // incoming offer
            //     if (json.to == user) {
            //         user2 = json.from;
            //         processOffer(json.data)
            //     }
            // } else 
            if (data.type == "answer") {
                // incoming answer
                peerConnection.setRemoteDescription(new RTCSessionDescription(data.data));
                addlog("Set Remote Description")
                return
            }
            if (json.action == "candidate") {
                peerConnection.addIceCandidate(new RTCIceCandidate(json.data)).catch(e => {
                    addlog("Error: add Ice Candidate: " + toString(e))
                })
                addlog("add Ice Candidate")
                return
            }
        }
        ws.onerror = (e) => {
            addlog("Websocket error");
        }


        ws.onopen = (e) => {
            addlog("Websocket opened");

            peerConnection = new RTCPeerConnection();
            peerConnection.onicecandidate = (e) => {
                if (!peerConnection || !e || !e.candidate) return;
                var candidate = event.candidate;

                upload = JSON.stringify({ type: "candidate", data: candidate });
                ws.send(upload);
                addlog("Websocket send candidate: " + upload);
            }
            addlog("create PeerConnection")

            //datachannel
            dataChannel = peerConnection.createDataChannel("dc");
            dataChannel.onclose = () => addlog('DataChannel close')
            dataChannel.onopen = () => addlog('DataChannel open')
            dataChannel.onerror = () => addlog('DataChannel error')
            //dataChannel.onmessage = e => addlog(`Message from DataChannel '${dataChannel.label}' payload '${e.data}'`)
            peerConnection.ondatachannel = (e) => {
                console.log('peerConnection.ondatachannel event fired.');
                ev.channel.onopen = () => {
                    console.log('Data channel is open and ready to be used.');
                };
                ev.channel.onmessage = (e) => {
                    addlog(`Message from DataChannel: ${e.data}'`);
                }
            }
            // maybe add stream

            //create offer
            var sdpConstraints = {
                offerToReceiveAudio: false,
                offerToReceiveVideo: false,
            };
            peerConnection.createOffer(sdpConstraints).then((sdp) => {
                peerConnection.setLocalDescription(sdp);
                upload = JSON.stringify({ type: "candidate", data: sdp });
                ws.send(upload);
                addlog("Websocket send offer: " + upload);
            }, function (err) {
                addlog(toString(err))
            });
        };
    });

    $("#ws-disconnect").click(() => {
        if (!ws)
            return;
        ws.close();
        ws = null;
    })

    // function setMyId(e) {
    //     e.preventDefault();
    //     user = $("#user").val();
    //     $("#dcform").show();
    //     return false;
    // }

    // var config = {};
    // var connection = {};




    // function connectTo(e) {
    //     e.preventDefault();
    //     user2 = $("#connectTo").val();
    //     openDataChannel();

    //     var sdpConstraints = { offerToReceiveAudio: true, offerToReceiveVideo: false }
    //     peerConnection.createOffer(sdpConstraints).then(function (sdp) {
    //         peerConnection.setLocalDescription(sdp);
    //         sendNegotiation("offer", sdp);
    //         console.log("------ SEND OFFER ------");
    //     }, function (err) {
    //         console.log(err)
    //     });

    // }

    // function sendDirect(e) {
    //     e.preventDefault();
    //     dataChannel.send($("#message").val());
    //     $('body').append('Me: <div class="message">' + $("#message").val() + '</div>');
    //     console.log("Sending over datachannel: " + $("#message").val());
    //     $("#message").val('');
    // }

    // function getURLParameter(name) {
    //     return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [, ""])[1].replace(/\+/g, '%20')) || null
    // }


    // function openDataChannel() {
    //     peerConnection = new webkitRTCPeerConnection(config, connection);
    //     peerConnection.onicecandidate = function (e) {
    //         if (!peerConnection || !e || !e.candidate) return;
    //         var candidate = event.candidate;
    //         sendNegotiation("candidate", candidate);
    //     }

    //     dataChannel = peerConnection.createDataChannel("datachannel", { reliable: false });

    //     dataChannel.onopen = function () {
    //         console.log("------ DATACHANNEL OPENED ------")
    //         $("#sendform").show();
    //     };
    //     dataChannel.onclose = function () { console.log("------ DC closed! ------") };
    //     dataChannel.onerror = function () { console.log("DC ERROR!!!") };

    //     peerConnection.ondatachannel = function (ev) {
    //         console.log('peerConnection.ondatachannel event fired.');
    //         ev.channel.onopen = function () {
    //             console.log('Data channel is open and ready to be used.');
    //         };
    //         ev.channel.onmessage = function (e) {
    //             console.log("DC from [" + user2 + "]:" + e.data);
    //             $('body').append(user2 + ': <div class="message from">' + e.data + '</div>')
    //         }
    //     };

    //     return peerConnection
    // }

    // function sendNegotiation(type, sdp) {
    //     var json = { from: user, to: user2, action: type, data: sdp };
    //     ws.send(JSON.stringify(json));
    //     console.log("Sending [" + user + "] to [" + user2 + "]: " + JSON.stringify(sdp));
    // }

    // function processOffer(offer) {
    //     var peerConnection = openDataChannel();
    //     peerConnection.setRemoteDescription(new RTCSessionDescription(offer)).catch(e => {
    //         console.log(e)
    //     });

    //     var sdpConstraints = {
    //         'mandatory':
    //         {
    //             'OfferToReceiveAudio': false,
    //             'OfferToReceiveVideo': false
    //         }
    //     };

    //     peerConnection.createAnswer(sdpConstraints).then(function (sdp) {
    //         return peerConnection.setLocalDescription(sdp).then(function () {
    //             sendNegotiation("answer", sdp);
    //             console.log("------ SEND ANSWER ------");
    //         })
    //     }, function (err) {
    //         console.log(err)
    //     });
    //     console.log("------ PROCESSED OFFER ------");

    // };


    // function processIce(iceCandidate) {
    //     peerConnection.addIceCandidate(new RTCIceCandidate(iceCandidate)).catch(e => {
    //         debugger
    //         console.log(e)
    //     })
    // }

</script>

</html>