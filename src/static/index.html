<!DOCTYPE html>
<html>

<head>
    <title>Simple DataChannel</title>
    <script src="js/jquery.min.js"></script>
</head>

<body>
    <!-- <form id="idform" action="" onsubmit="return false;">
        <input type="text" id="name">
        <button id="set_name">Set your name</button>
    </form> -->

    <button id="ws-connect">Connect to WebSocket</button>
    <button id="ws-disconnect">Disconnect</button>
    <br>
    <br>
    <br>

    <div>
        name: <span id="msg_name"></span><br>
        host: <span id="msg_host"></span><br>
        prot: <span id="msg_prot"></span><br>
    </div>
    <br>

    <div>
        log:
        <button onclick="$('#log_content').html('');">clear</button>
        <div id="log_content"></div>
    </div>
</body>

<script>

    function addlog(msg) {
        t = $('#log_content').html();
        t += msg + "<br>"
        $('#log_content').html(t);
    }

    var host = window.location.host;
    var is_sec = window.location.protocol == "https:";

    var peerConnection = null;

    var dataChannel = null;

    $("#msg_host").html(host);
    $("#msg_prot").html(is_sec ? "https" : "http");


    var ws = null;
    var name = "";
    $("#set_name").click(() => {
        if (ws) {
            alert("disconnect first!");
            return
        }
        name = $("#name").val()
        $("#msg_name").html(name);
        addlog("set name: " + name);
    });
    $("#ws-connect").click(() => {
        if (ws)
            return;

        u = ""
        if (is_sec)
            u = "wss://" + host + "/api/ws"
        else
            u = "ws://" + host + "/api/ws"
        addlog("connect to " + u);
        ws = new WebSocket(u);

        ws.onclose = (e) => {
            addlog("Websocket closed");
        }
        ws.onmessage = (e) => {
            addlog("Websocket message" + e.data);
            var data = JSON.parse(e.data);
            if (data.action == "answer") {
                // incoming answer
                peerConnection.setRemoteDescription(new RTCSessionDescription(data.data));
                addlog("Set Remote Description")
                return
            }
            if (json.action == "candidate") {
                peerConnection.addIceCandidate(new RTCIceCandidate(json.data)).catch(e => {
                    addlog("Error: add Ice Candidate: " + toString(e))
                })
                addlog("add Ice Candidate")
                return
            }
        }
        ws.onerror = (e) => {
            addlog("Websocket error");
        }


        ws.onopen = (e) => {
            addlog("Websocket opened");

            peerConnection = new RTCPeerConnection();
            peerConnection.onicecandidate = (e) => {
                if (!peerConnection || !e || !e.candidate) return;
                var candidate = event.candidate;

                upload = JSON.stringify({ action: "candidate", data: candidate });
                ws.send(upload);
                addlog("Websocket send candidate: " + upload);
            }
            addlog("create PeerConnection")

            //datachannel
            dataChannel = peerConnection.createDataChannel("dc");
            dataChannel.onclose = () => addlog('DataChannel close')
            dataChannel.onopen = () => {
                addlog('DataChannel open');
                dataChannel.send("Hello world!");
            }
            dataChannel.onerror = () => addlog('DataChannel error')
            dataChannel.onmessage = (e) => {
                    addlog(`Message from DataChannel: ${e.data}'`);
                }
            
            // maybe add stream

            //create offer
            var sdpConstraints = {
                offerToReceiveAudio: false,
                offerToReceiveVideo: false,
            };
            peerConnection.createOffer(sdpConstraints).then((sdp) => {
                peerConnection.setLocalDescription(sdp);
                upload = JSON.stringify({ action: "offer", data: sdp });
                ws.send(upload);
                addlog("Websocket send offer: " + upload);
            }, function (err) {
                addlog(toString(err))
            });
        };
    });

    $("#ws-disconnect").click(() => {
        if (!ws)
            return;
        ws.close();
        ws = null;
    })
</script>

</html>